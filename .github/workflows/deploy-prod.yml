# deploy-prod.yml v1.0.0
name: Deploy to Prod

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: [self-hosted, prod]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore WebsiteAdmin
        working-directory: src/WebsiteAdmin
        run: dotnet restore WebsiteAdmin.csproj

      - name: Restore WebsiteCustomer
        working-directory: src/WebsiteCustomer
        run: dotnet restore WebsiteCustomer.csproj

      - name: Build WebsiteAdmin
        working-directory: src/WebsiteAdmin
        run: dotnet build WebsiteAdmin.csproj --configuration Release --no-restore

      - name: Build WebsiteCustomer
        working-directory: src/WebsiteCustomer
        run: dotnet build WebsiteCustomer.csproj --configuration Release --no-restore

      - name: Install dotnet-ef tool
        run: dotnet tool install --global dotnet-ef --version 9.0.0 || dotnet tool update --global dotnet-ef --version 9.0.0

      - name: Run EF database migrations
        working-directory: src
        run: dotnet ef database update --project Common/Common.csproj --startup-project WebsiteAdmin/WebsiteAdmin.csproj

      - name: Publish WebsiteAdmin
        working-directory: src/WebsiteAdmin
        run: dotnet publish WebsiteAdmin.csproj -c Release -o ../../publish/WebsiteAdmin

      - name: Publish WebsiteCustomer
        working-directory: src/WebsiteCustomer
        run: dotnet publish WebsiteCustomer.csproj -c Release -o ../../publish/WebsiteCustomer

      - name: Deploy WebsiteAdmin to IIS
        shell: powershell
        run: |
          Import-Module WebAdministration

          $solutionName = "BirthdayReminder"
          $appPoolName = "$solutionName-WebsiteAdmin-Prod"
          $baseFolder = "C:\inetpub\$solutionName\WebsiteAdmin\Prod"
          $currentLink = Join-Path $baseFolder "current"
          $tempLink = Join-Path $baseFolder "current_new"

          # Extract version from .csproj
          [xml]$csproj = Get-Content "src\WebsiteAdmin\WebsiteAdmin.csproj"
          $version = $csproj.Project.PropertyGroup.Version
          if (-not $version) { $version = "1.0.0" }
          Write-Host "Deploying WebsiteAdmin version: $version"

          $versionFolder = Join-Path $baseFolder $version

          # Create version folder and copy files
          if (Test-Path $versionFolder) {
            Remove-Item $versionFolder -Recurse -Force
          }
          New-Item -ItemType Directory -Path $versionFolder -Force | Out-Null
          Copy-Item -Path "publish\WebsiteAdmin\*" -Destination $versionFolder -Recurse -Force

          # Stop AppPool
          try {
            $state = Get-WebAppPoolState -Name $appPoolName
            if ($state.Value -eq "Started") {
              Stop-WebAppPool -Name $appPoolName
              Start-Sleep -Seconds 5
            }
          } catch {
            Write-Host "AppPool not running or doesn't exist yet"
          }

          # Switch symlink
          if (Test-Path $tempLink) { cmd /c rmdir $tempLink 2>$null }
          cmd /c mklink /J $tempLink $versionFolder | Out-Null
          if (Test-Path $currentLink) { cmd /c rmdir $currentLink 2>$null }
          Rename-Item $tempLink "current"

          # Start AppPool with retry
          $retries = 3
          for ($i = 1; $i -le $retries; $i++) {
            try {
              Start-WebAppPool -Name $appPoolName
              Write-Host "AppPool started successfully"
              break
            } catch {
              Write-Host "Retry $i/$retries - waiting for AppPool..."
              Start-Sleep -Seconds 3
            }
          }

          Write-Host "Deployed WebsiteAdmin: $versionFolder"

      - name: Deploy WebsiteCustomer to IIS
        shell: powershell
        run: |
          Import-Module WebAdministration

          $solutionName = "BirthdayReminder"
          $appPoolName = "$solutionName-WebsiteCustomer"
          $baseFolder = "C:\inetpub\$solutionName\WebsiteCustomer\Prod"
          $currentLink = Join-Path $baseFolder "current"
          $tempLink = Join-Path $baseFolder "current_new"

          # Extract version from .csproj
          [xml]$csproj = Get-Content "src\WebsiteCustomer\WebsiteCustomer.csproj"
          $version = $csproj.Project.PropertyGroup.Version
          if (-not $version) { $version = "1.0.0" }
          Write-Host "Deploying WebsiteCustomer version: $version"

          $versionFolder = Join-Path $baseFolder $version

          # Create version folder and copy files
          if (Test-Path $versionFolder) {
            Remove-Item $versionFolder -Recurse -Force
          }
          New-Item -ItemType Directory -Path $versionFolder -Force | Out-Null
          Copy-Item -Path "publish\WebsiteCustomer\*" -Destination $versionFolder -Recurse -Force

          # Stop AppPool
          try {
            $state = Get-WebAppPoolState -Name $appPoolName
            if ($state.Value -eq "Started") {
              Stop-WebAppPool -Name $appPoolName
              Start-Sleep -Seconds 5
            }
          } catch {
            Write-Host "AppPool not running or doesn't exist yet"
          }

          # Switch symlink
          if (Test-Path $tempLink) { cmd /c rmdir $tempLink 2>$null }
          cmd /c mklink /J $tempLink $versionFolder | Out-Null
          if (Test-Path $currentLink) { cmd /c rmdir $currentLink 2>$null }
          Rename-Item $tempLink "current"

          # Start AppPool with retry
          $retries = 3
          for ($i = 1; $i -le $retries; $i++) {
            try {
              Start-WebAppPool -Name $appPoolName
              Write-Host "AppPool started successfully"
              break
            } catch {
              Write-Host "Retry $i/$retries - waiting for AppPool..."
              Start-Sleep -Seconds 3
            }
          }

          Write-Host "Deployed WebsiteCustomer: $versionFolder"

      - name: Health check
        shell: powershell
        run: |
          $urls = @(
            "https://prod.birthday-reminder.online/health",
            "https://birthday-reminder.online/health"
          )
          Start-Sleep -Seconds 5
          foreach ($url in $urls) {
            try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30
              if ($response.StatusCode -eq 200) {
                Write-Host "Health check passed: $url"
              } else {
                Write-Host "Health check returned: $($response.StatusCode)"
              }
            } catch {
              Write-Host "Health check failed or endpoint not available: $url - $_"
            }
          }
